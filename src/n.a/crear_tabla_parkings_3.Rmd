---
title: "Tratamiento de datos"
author: "Izaskun Lopez-Samaniego"
date: "9 de julio de 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require("knitr")
opts_knit$set(root.dir="./")

```

## Preparación del entorno


```{r entorno}
library(data.table)

ruta <-'C:/Users/izask/Modelo Parking/Modelo Parkings/src'
setwd(ruta)

source('./R_funciones.R')

t.parkings <- as.data.table(read.csv('../dat/tabla_parkings.csv',
                       sep = ';', dec = ',',header = TRUE))
```

## Analisis descriptivo de las variables

 
```{r descriptivo, echo=FALSE}
summary(t.parkings)

```
    
    1. Variables relacionadadas con la reserva:
          - Facturación: 

            # El 25% de los parkings tienen una facturación inferior a 60???: estandarizaremos la variable en este tramo
            # Si la facturacion es superior a 254??? realizaremos un logaritmo para normalizar la variable.

          - Promoter:
        
              # Distribución normal ¿o exponencial a excepción del valor 10?

```{r descriptivo reservas, echo=FALSE}
par(mfrow=c(2,3))
hist(t.parkings[monthly.ingresos<=60,]$monthly.ingresos, main='facturacion media mensual')
hist(t.parkings[monthly.ingresos>60 & monthly.ingresos<=274,]$monthly.ingresos, main='facturacion media mensual')
hist(t.parkings[monthly.ingresos>274,]$monthly.ingresos, main='facturacion media mensual')
hist(t.parkings$Mean.Promoter, main='NPS medio')

```

    #Transformamos con un logaritmo los ingresos mensuales
    #Estandarizamos el NPS (media, varianza): z=(X-media)/dest.tip; ¿merece la pena?
        MEDIA = 8.095369
        SD    = 1.717961

    ```{r trasformar reservas, echo=FALSE}
t.parkings[, monthly.ingresos.log := log(monthly.ingresos)]
t.net.promoter.estandar <- t.parkings[, list(mean.NPS=mean(Mean.Promoter, na.rm = TRUE),
                                             sd.NPS=sd(Mean.Promoter, na.rm = TRUE))]  
t.parkings[, z.Mean.Promoter := (Mean.Promoter-t.net.promoter.estandar$mean.NPS)/t.net.promoter.estandar$sd.NPS]

par(mfrow=c(1,2))
hist(t.parkings$monthly.ingresos.log, main='Log facturacion media mensual')
hist(t.parkings$z.Mean.Promoter, main='normalizado NPS medio')

```
    
    2. Variables relacionadadas con las caracteristicas del parking:
          - Altura máxima: 

            # Sigue una distribución logaritmica, mucha frecuencia en las alturas mas bajas y un rápido descenso posterior
 
```{r descriptivo caracteristicas parking, echo=FALSE}
par(mfrow=c(3,1))
hist(t.parkings$Max_height, main='Altura máxima vehiculos')
hist(t.parkings$Stock, main='Stock')
hist(t.parkings$Spots, main='Spots')
```
Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


#clasificador NAIVE BAYES
```{r NAIVYE BAYES, echo=FALSE}
library(caret)

n.test<-ncol(t.parkings)*1.00
parkings.test <-sample(t.parkings[!is.na(Mean.Promoter)], 
                       n.test, replace = FALSE)
ctrl <- trainControl(method = "cv", savePred=T,
                     classProb=T, number = 10)

nv.modell <- train(Mean.Promoter~.,
                   data = parkings.test[,-c('Parking', 'monthly.ingresos')],
                   method = 'svmLinear',
                   trControl = ctrl)

```