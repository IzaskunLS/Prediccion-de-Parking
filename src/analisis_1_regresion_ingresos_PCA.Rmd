---
title: "Tratamiento de datos"
author: "Izaskun Lopez-Samaniego"
date: "9 de julio de 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require("knitr")
opts_knit$set(root.dir="./")

```

## Preparación del entorno


```{r entorno}
library(data.table)
library(caret)

source('./R_funciones.R')

t.parkings.analizar <- as.data.table(read.csv('../dat/datos_parkings.csv',
                       sep = ';', dec = ',',header = TRUE))
t.parkings.analizar <- t.parkings.analizar[,-c('Id_parking',
                                               'desc.NPS')]
t.parkings.analizar <- na.omit(t.parkings.analizar)

```



#PCA

Realizamos una reducción lineal de las variables con componentes principales

  - Con 28 componentes recogemos el 85% de la información

```{r PCA, echo=FALSE}

parking.pca <- prcomp(t.parkings.analizar[,-c('monthly.ingresos.log')],
                      center = FALSE,
                      scale. = FALSE)
parking.pca
pr.var = parking.pca$sdev^2   #autovalores
pve = pr.var/sum(pr.var)
cumsum(pve[1:55])

t.parkings.analizar.pca <- predict(parking.pca, 
                                   t.parkings.analizar[,-c('monthly.ingresos.log')])
t.parkings.analizar.pca<- cbind(t.parkings.analizar[,c('monthly.ingresos.log')],
                                t.parkings.analizar.pca[,1:28])
```


## Dividimos la muestra en casos de test y casos de training

```{r test and testing, echo=FALSE}

inTrain <- sample(1:nrow(t.parkings.analizar.pca),
                  nrow(t.parkings.analizar.pca)*0.3)

train.Ingresos  <- t.parkings.analizar.pca[-inTrain,]
test.Ingresos   <- t.parkings.analizar.pca[inTrain,]

```

## Test Modelo SVM

```{r SVM, echo=FALSE}
bootControl <- trainControl(method = "cv",
                            savePred=T)
svm.fit <- train(monthly.ingresos.log~., 
                 data= train.Ingresos, 
                 method = "svmRadial", tuneLength = 3, 
                 trControl = bootControl, scaled = F)

svm.fit

svm.fit$finalModel

# Density plots de los diferentes folds/iteraciones
resampleHist(svm.fit)

```

  - Realizamos un análisis de la importancia de las variables en cada modelo

```{r SVM Imp Variables, echo=FALSE}
svmImp <- varImp(svm.fit, scale = F)
svmImp
plot(svmImp, top = 20, main = "SVM Importance")
```


```{r SVM Lineal, echo=FALSE}
bootControl <- trainControl(method = "cv",
                            savePred=T)
svm.fit <- train(monthly.ingresos.log~., 
                 data= train.Ingresos, 
                 method = "svmLinear", tuneLength = 3, 
                 trControl = bootControl, scaled = F)

svm.fit

svm.fit$finalModel

# Density plots de los diferentes folds/iteraciones
resampleHist(svm.fit)

```

## Test Modelo Random Forest

```{r RF, echo=FALSE}

bootControl <- trainControl(method = "cv", number = 4)
rf.fit <- train(monthly.ingresos.log~., 
                 data= train.Ingresos, 
                method = "rf", tuneLength = 4, 
                trControl = bootControl, scaled = F, 
                do.trace = T, ntree = 100,
                importance=T)



rf.fit
rf.fit$finalModel
plot(rf.fit)
```


  - Realizamos un análisis de la importancia de las variables en cada modelo

```{r RF Imp Variables, echo=FALSE}
rfImp <- varImp(rf.fit, scale = F)
rfImp
```


## Test Modelo Redes Neuronales

```{r RN, echo=FALSE}

bootControl <- trainControl(method = "cv", number = 4)
nnet.fit <- train(monthly.ingresos.log~., 
                 data= train.Ingresos, 
                 method = "nnet",
                 trControl = bootControl, scaled = T)
nnet.fit
nnet.fit$finalModel
plot(nnet.fit)
```


```{r NN Imp Variables, echo=FALSE}
nnImp <- varImp(nnet.fit, scale = F)
nnImp
```


#Realizamos el test sobre random forest
  
  - Hemos visto como Random Forest es el modelo que mejor se ajusta pero empeora con respecto a los modelos probados anteriormente (RF con todas las variables, RF con variables principales).

```{r Test de los modelos, echo=FALSE}

predValues <- predict(rf.fit,
                      , newdata = test.Ingresos[,-c('monthly.ingresos.log')])

  
par(mfrow=c(1,1))
plot(predValues, test.Ingresos$monthly.ingresos.log, main="ARBOLES")
abline(0,1,lty=2,col=2)   

```